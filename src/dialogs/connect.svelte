<script>
  import { createEventDispatcher } from "svelte";
  import { ArweaveWebWallet } from "arweave-wallet-connector";

  import { profile } from "../store.js";

  export let id = window.crypto.randomUUID();
  export let open = false;
  export let cancel = true;
  export let bgColor = "bg-white";
  export let border = "border-4 border-[#929292]";

  const dispatch = createEventDispatcher();

  async function arconnect() {
    if (!window.arweaveWallet) {
      window.open("https://arconnect.io");
    }
    try {
      await arweaveWallet.disconnect();
      await arweaveWallet.connect(
        ["ACCESS_ADDRESS", "SIGN_TRANSACTION", "DISPATCH"],
        { name: "specs" }
      );
      const addr = await arweaveWallet.getActiveAddress();
      $profile = { addr };
      open = false;
      dispatch("connected");
    } catch (e) {
      console.log(e);
    }
  }

  async function arwallet() {
    try {
      const wallet = new ArweaveWebWallet({
        name: "pst",
      });
      wallet.setUrl("arweave.app");
      await wallet.connect();

      const addr = await arweaveWallet.getActiveAddress();
      $profile = { addr };
      open = false;
      dispatch("connected");
    } catch (e) {
      console.log(e);
    }
  }

  function cancelClick() {
    open = false;
  }
</script>

<input type="checkbox" {id} bind:checked={open} class="modal-toggle" />
<div class="modal">
  <div class="modal-box  {bgColor} {border}">
    {#if cancel}
      <button
        on:click={cancelClick}
        class="btn btn-sm btn-circle absolute right-2 top-2">âœ•</button
      >
    {/if}
    <div class="px-[36px] py-[24px] flex flex-col space-y-8">
      <img class="h-[55px] w-[55px]" src="assets/wallet.svg" alt="wallet" />
      <h2 class="text-2xl font-bold text-[#160042]">
        Arweave wallet needed to post
      </h2>
      <p class="text-xl  text-[#160042]">Select your preferred wallet below:</p>
      <button
        class="btn btn-block rounded-full hover:bg-gray-400"
        on:click={arconnect}>ArConnect</button
      >
      <button
        on:click={arwallet}
        class="btn btn-block rounded-full bg-[#E4E6F1] text-black hover:bg-gray-400"
        >Arweave.app</button
      >
      <button
        on:click={() => {
          dispatch("help");
          open = false;
        }}
        class="link no-underline text-center  text-[#160042]"
        >I don't have a wallet</button
      >
    </div>
  </div>
</div>
